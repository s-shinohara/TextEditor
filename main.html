<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style>
body {
  margin: 0;
}

#editorOuterbox {
  width: 100%;
  background: #FFF;
  
  position: fixed;
  top: 0;
  left: 0;
}

#editor {
}

#textBeingEdited {
  width: 100%;
}
  
#bOuterbox {
}
</style>

</head>
<body>

<div id="editorOuterbox">
<form id="editor" name="editor">
<div id="textBeingEditedOuterbox">
  <textarea id="textBeingEdited" rows="2" cols="10"></textarea>
</div>
<div id="startOuterbox">
  <input type="number" id="startNum" size="8" defaultvalue="0" placeholder="0" />
  <input type="button" class="setSelectionRange start back" value=" < " />
  <input type="number" id="startNumberDelta" size="8" defaultvalue="0" placeholder="0" />
  <input type="button" class="setSelectionRange start forward" value=" > " />
</div>
<div id="endOuterbox">
  <input type="number" id="endNum" cols="8" defaultvalue="0" placeholder="0" />
  <input type="button" class="setSelectionRange end back" value=" < " />
  <input type="number" id="endNumberDelta" cols="8" defaultvalue="0" placeholder="0" />
  <input type="button" class="setSelectionRange end forward" value=" > " />
</div>
<div id="replaceOuterbox">
  <input type="button" id="replace" value="replace" />
  <input type="text" id="replaceTo" placeholder="hogehoge" />
  <div id="stringToBeReplaced"></div>
</div>
</form>
</div>
  
<div id="bOuterbox">
  <div>
    <pre><code id="b"></code></pre>
  </div>
</div>
  
<script>
var theDOM;

function loadDOM() {
  theDOM = new Object();
  
  theDOM.rwEditor = document.getElementById("editor");
  theDOM.rTextBeingEdited = document.getElementById("textBeingEdited").value;
  theDOM.rwStartNum = document.getElementById("startNum");
  theDOM.rwEndNum = document.getElementById("endNum");
  theDOM.rNewText = document.getElementById("replaceTo").value;
  theDOM.rwStringToBeReplaced = document.getElementById("stringToBeReplaced");
  theDOM.rwB = document.getElementById("b");
}

function init() {
  loadDOM();
  
  theDOM.prototype.copy = (function() {
    return (function() {
      copy();
    });
  }) ();

  theDOM.prototype.setStringToBeReplaced = (function() {
    return (function() {
      setStringToBeReplaced(rTextBeingEdited.substring(rwStartNum.value, rwEndNum.value));
    });
  }) ();
  
  theDOM.prototype.calculateCSS = (function() {
    return (function() {
      calculateCSS();
    });
  }) ();
  
  theDOM.prototype.attachLoadDOM = (function() {
    return (function() {
      attachLoadDOM();
    });
  }) ();
  
} init();
  
function attachLoadDOM() {
  var element;
  var elementArray;
  elementArray = new Array();
    
  var idList = ["textBeingEdited", "startNum", "startNumberDelta", "endNum", "endNumberDelta", "replaceTo"];
  
  for (var i = 0; i < idList.length; i++) {
    elementArray = elementArray.push(document.getElementById(idList[i]));
  }
  
  for (var i = 0; i < elementArray.length; i++) {
    element = elementArray[i];

    var onchange_;
//    onchange_ = element.onchange;
    
    var obj;
    obj = theDOM;
    
    if (element.id == "textBeingEdited") {
      onchange_ = (function() {
        return (function() {
          element.onchange();
          obj.copy();
          obj.setSrtingToBeReplaced();
          obj.calculateCSS();
        });
      }) ();
    }
    
    element.onchange = (function() {
      return (function() {
        loadDOM();
        onchange_();
      });
    }) ();
  }
}
  
function copy() {
  var elementB = document.getElementById("b");
  var elementTextBeingEdited = document.getElementById("textBeingEdited");
  elementB.textContent = elementTextBeingEdited.value;
}

function setStringToBeReplaced(string) {
  var elementTextBeingEdited = document.getElementById("textBeingEdited");
  elementStringToBeReplaced.textContent = string;
}

function changeSelectionRange(startOrEnd, backOrForward) {
  var elementTextBeingEdited = document.getElementById("textBeingEdited");
  var elementStartNumberDelta = document.getElementById("startNumberDelta");
  var elementEndNumberDelta = document.getElementById("endNumberDelta");
  var selectionStart = elementTextBeingEdited.selectionStart;
  var selectionEnd = elementTextBeingEdited.selectionEnd;
  var delta, _delta;
  
  if (startOrEnd == "start") {
    _delta = elementStartNumberDelta.value;
  } else if (startOrEnd == "end") {
    _delta = elementEndNumberDelta.value;
  }

  delta = parseInt(_delta);
  
  if (backOrForward == "back") {
    delta = -1 * delta;
  }
  
  if (startOrEnd == "start") {
    selectionStart = selectionStart + delta;
    if (selectionStart < 0) selectionStart = 0;
    if (selectionEnd < selectionStart) selectionEnd = selectionStart;
  } else if (startOrEnd == "end") {
    selectionEnd = selectionEnd + delta;
    if (selectionEnd < selectionStart) selectionEnd = selectionStart;
  }
  elementTextBeingEdited.setSelectionRange(selectionStart, selectionEnd);
  elementTextBeingEdited.focus();

  setStringToBeReplaced(elementTextBeingEdited.value.substring(selectionStart, selectionEnd));
  
  var elementStartNum;
  var elementEndNum;
  
  elementStartNum = document.getElementById("startNum");
  elementEndNum = document.getElementById("endNum");

  elementStartNum.value = selectionStart;
  elementEndNum.value = selectionEnd;
}
 
function calculateCSS() {
  var editorRect;
  var editorBottom;
  
  editorRect = elementEditor.getClientRects();
  editorBottom = editorRect[0].bottom;
  
  elementBOuterbox.style.margin = editorBottom.toString() + "px 0 0";
}
 
window.onload = (function() {
  
  calculateCSS();
  
  var startOrEnd;
  var backOrForward;

  var elementTextBeingEdited = document.getElementById("textBeingEdited");
  
  var elementArray;
  var element;

  elementArray = document.getElementsByTagName("input");
  
  for(var i = 0; i < elementArray.length; i++) {
    element = elementArray[i];
    
    var classNames = element.className.split(" ");
    
    if (isStringInStringArray("setSelectionRange", classNames)) {
      if (isStringInStringArray("start", classNames)) {
        startOrEnd = "start";
      } else if (isStringInStringArray("end", classNames)) {
        startOrEnd = "end";
      }

      if (isStringInStringArray("back", classNames)) {
        backOrForward = "back";
      } else if (isStringInStringArray("forward", classNames)) {
        backOrForward = "forward";
      }
      
      element.onclick = (function() {
        var soe = startOrEnd;
        var bof = backOrForward;
        return function() {
          changeSelectionRange(soe, bof);
          calculateCSS();
        };
      }) ();
    }

    if (element.id == "startNum") {
      element.value = elementTextBeingEdited.selectionStart;
    } else if (element.id == "endNum") {
      element.value = elementTextBeingEdited.selectionEnd;
    }

  }
  
  document.getElementById("replace").onclick = (function() {
    return function() {
      var textBeingEdited = document.getElementById("textBeingEdited");
      var newText = document.getElementById("replaceTo").value;
      var start = textBeingEdited.selectionStart;
      var end = textBeingEdited.selectionEnd;

      textBeingEdited.setRangeText(newText, start, end, "select");

      copy();

      setStringToBeReplaced();

      calculateCSS();

      textBeingEdited.setSelectionRange(start, end);
      textBeingEdited.focus();

    };
  })();
  
  attachLoadDOM();

})();
 
function isStringInStringArray(str, strArray) {
  var i;
  for (i = 0; i < strArray.length; i++) {
    if (str == strArray[i]) return true;
  }
  
  return false;
}
  
</script>

</body>
</html>
